#!/bin/bash
#===============================================================================
# Field Suite - ุณูุฑูุจุช ุงูุฅุนุฏุงุฏ ูุงูุชุดุบูู
# ูุชุนุงูู ูุน ุฌููุน ุญุงูุงุช ุงูุฎุทุฃ ููููุฑ ุชุฌุฑุจุฉ ุณูุณุฉ
#===============================================================================

set -e  # ุงูุชููู ุนูุฏ ุฃูู ุฎุทุฃ

# ุงูุฃููุงู ููุฅุฎุฑุงุฌ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ุงูุฏูุงู ุงููุณุงุนุฏุฉ
log_info() { echo -e "${BLUE}โน๏ธ  $1${NC}"; }
log_success() { echo -e "${GREEN}โ $1${NC}"; }
log_warning() { echo -e "${YELLOW}โ๏ธ  $1${NC}"; }
log_error() { echo -e "${RED}โ $1${NC}"; }

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "   ๐พ Field Suite - Agricultural Field Management Platform"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

#-------------------------------------------------------------------------------
# 1๏ธโฃ ุงูุชุญูู ูู ุงููุชุทูุจุงุช ุงููุณุจูุฉ
#-------------------------------------------------------------------------------
log_info "ุงูุชุญูู ูู ุงููุชุทูุจุงุช ุงููุณุจูุฉ..."

# ูุญุต Docker
if ! command -v docker &> /dev/null; then
    log_error "Docker ุบูุฑ ูุซุจุช!"
    echo "   ูู ุจุชุซุจูุชู ูู: https://docs.docker.com/get-docker/"
    exit 1
fi

# ูุญุต Docker Compose
if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    log_error "Docker Compose ุบูุฑ ูุซุจุช!"
    echo "   ูู ุจุชุซุจูุชู ูู: https://docs.docker.com/compose/install/"
    exit 1
fi

# ูุญุต ุฃู Docker ูุนูู
if ! docker info &> /dev/null; then
    log_error "Docker daemon ุบูุฑ ูุนูู!"
    echo "   ูู ุจุชุดุบูู Docker Desktop ุฃู: sudo systemctl start docker"
    exit 1
fi

log_success "ุฌููุน ุงููุชุทูุจุงุช ูุชููุฑุฉ"

#-------------------------------------------------------------------------------
# 2๏ธโฃ ุฅุนุฏุงุฏ ููู ุงูุจูุฆุฉ
#-------------------------------------------------------------------------------
log_info "ุฅุนุฏุงุฏ ููู ุงูุจูุฆุฉ..."

if [ ! -f ".env" ]; then
    if [ -f "backend/.env.example" ]; then
        cp backend/.env.example .env
        log_success "ุชู ุฅูุดุงุก ููู .env ูู ุงููููุฐุฌ"
        log_warning "ูููุตุญ ุจูุฑุงุฌุนุฉ ูุชุนุฏูู ุงูููู ูู .env"
    else
        log_warning "ูุง ููุฌุฏ ููู .env.exampleุ ุณูุชู ุงุณุชุฎุฏุงู ุงูููู ุงูุงูุชุฑุงุถูุฉ"
    fi
else
    log_success "ููู .env ููุฌูุฏ ุจุงููุนู"
fi

#-------------------------------------------------------------------------------
# 3๏ธโฃ ุนุฑุถ ุฎูุงุฑุงุช ุงูุชุดุบูู
#-------------------------------------------------------------------------------
echo ""
echo "ุงุฎุชุฑ ุทุฑููุฉ ุงูุชุดุบูู:"
echo "  1) ๐ ุชุดุบูู ุณุฑูุน (ุงุณุชุฎุฏุงู cache)"
echo "  2) ๐จ ุจูุงุก ุฌุฏูุฏ (ุจุฏูู cache)"
echo "  3) ๐ ุฅููุงู ุงูุฎุฏูุงุช"
echo "  4) ๐ ุนุฑุถ ุญุงูุฉ ุงูุฎุฏูุงุช"
echo "  5) ๐ ุนุฑุถ ุงูุณุฌูุงุช"
echo "  6) ๐งน ุชูุธูู ูุงูู (ุญุฐู containers ู images)"
echo ""
read -p "ุฃุฏุฎู ุงุฎุชูุงุฑู (1-6): " choice

case $choice in
    1)
        log_info "ุชุดุบูู ุงูุฎุฏูุงุช..."
        docker-compose up -d
        ;;
    2)
        log_info "ุจูุงุก ูุชุดุบูู ุงูุฎุฏูุงุช (ุจุฏูู cache)..."
        docker-compose build --no-cache
        docker-compose up -d
        ;;
    3)
        log_info "ุฅููุงู ุงูุฎุฏูุงุช..."
        docker-compose down
        log_success "ุชู ุฅููุงู ุฌููุน ุงูุฎุฏูุงุช"
        exit 0
        ;;
    4)
        log_info "ุญุงูุฉ ุงูุฎุฏูุงุช:"
        docker-compose ps
        exit 0
        ;;
    5)
        log_info "ุงูุณุฌูุงุช (ุขุฎุฑ 50 ุณุทุฑ):"
        docker-compose logs --tail=50 -f
        exit 0
        ;;
    6)
        log_warning "ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูู ุดูุกุ (y/n)"
        read -p "" confirm
        if [ "$confirm" = "y" ]; then
            docker-compose down -v --rmi all
            log_success "ุชู ุงูุชูุธูู ุงููุงูู"
        fi
        exit 0
        ;;
    *)
        log_error "ุฎูุงุฑ ุบูุฑ ุตุงูุญ"
        exit 1
        ;;
esac

#-------------------------------------------------------------------------------
# 4๏ธโฃ ุงูุชุธุงุฑ ุจุฏุก ุงูุฎุฏูุงุช
#-------------------------------------------------------------------------------
echo ""
log_info "ุงูุชุธุงุฑ ุจุฏุก ุงูุฎุฏูุงุช..."

# ุงูุชุธุงุฑ Backend
echo -n "   Backend: "
for i in {1..30}; do
    if curl -s http://localhost:8000/health/live > /dev/null 2>&1; then
        echo -e "${GREEN}ุฌุงูุฒ${NC}"
        break
    fi
    echo -n "."
    sleep 2
done

# ุงูุชุธุงุฑ Web
echo -n "   Web:     "
for i in {1..30}; do
    if curl -s http://localhost:3000 > /dev/null 2>&1; then
        echo -e "${GREEN}ุฌุงูุฒ${NC}"
        break
    fi
    echo -n "."
    sleep 2
done

#-------------------------------------------------------------------------------
# 5๏ธโฃ ุนุฑุถ ุญุงูุฉ ุงูุฎุฏูุงุช
#-------------------------------------------------------------------------------
echo ""
log_info "ุญุงูุฉ ุงูุฎุฏูุงุช:"
docker-compose ps

#-------------------------------------------------------------------------------
# 6๏ธโฃ ุนุฑุถ ุฑูุงุจุท ุงููุตูู
#-------------------------------------------------------------------------------
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "   ๐ ุฑูุงุจุท ุงููุตูู"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "   ๐ฑ Web Frontend:    http://localhost:3000"
echo "   ๐ API Backend:     http://localhost:8000"
echo "   ๐ API Docs:        http://localhost:8000/docs"
echo "   โค๏ธ  Health Check:   http://localhost:8000/health/live"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

log_success "ุงููุดุฑูุน ูุนูู ุจูุฌุงุญ!"
echo ""
echo "ุฃูุงูุฑ ูููุฏุฉ:"
echo "   docker-compose logs -f      # ูุชุงุจุนุฉ ุงูุณุฌูุงุช"
echo "   docker-compose ps           # ุญุงูุฉ ุงูุฎุฏูุงุช"
echo "   docker-compose down         # ุฅููุงู ุงูุฎุฏูุงุช"
echo "   ./setup.sh                  # ุฅุนุงุฏุฉ ุงูุชุดุบูู"
echo ""
