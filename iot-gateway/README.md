# ğŸŒ IoT Gateway Service

Ø®Ø¯Ù…Ø© Ø¨ÙˆØ§Ø¨Ø© Ø¥Ù†ØªØ±Ù†Øª Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ù„Ù…Ù†ØµØ© Sahool Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

IoT Gateway Ù‡ÙŠ Ø®Ø¯Ù…Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© ÙˆØ£Ø¬Ù‡Ø²Ø© IoT ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„. ØªØ¯Ø¹Ù… Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ MQTT Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ ÙˆØ§Ù„ÙØ¹Ø§Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.

## ğŸ¯ Ø§Ù„Ù…ÙŠØ²Ø§Øª

### 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
- ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Online/Offline)
- ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ù†Ø´Ø§Ø· Ù„Ù„Ø£Ø¬Ù‡Ø²Ø©
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© ÙˆÙ‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©

### 2. MQTT Integration
- Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ MQTT Broker
- Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Topics Ù…ØªØ¹Ø¯Ø¯Ø©
- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
- Ù†Ø´Ø± Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù„Ù„Ø£Ø¬Ù‡Ø²Ø©

### 3. Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
- **Ø­Ø³Ø§Ø³Ø§Øª Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø©** - Ù‚ÙŠØ§Ø³ Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø©
- **Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø©** - Ù‚ÙŠØ§Ø³ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
- **Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ø¬ÙˆÙŠØ©** - Ù‚ÙŠØ§Ø³ Ø§Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ù†Ø³Ø¨ÙŠØ©
- **Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ø¶ÙˆØ¡** - Ù‚ÙŠØ§Ø³ Ø´Ø¯Ø© Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©
- **Ø­Ø³Ø§Ø³Ø§Øª pH** - Ù‚ÙŠØ§Ø³ Ø­Ù…ÙˆØ¶Ø© Ø§Ù„ØªØ±Ø¨Ø©
- **Ø­Ø³Ø§Ø³Ø§Øª EC** - Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…ÙˆØµÙ„ÙŠØ© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©

### 4. Real-time Data
- WebSocket Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
- Broadcast Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ

## ğŸ› ï¸ Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©

- **FastAPI** - Ø¥Ø·Ø§Ø± Ø¹Ù…Ù„ Ø§Ù„Ù€ API
- **Paho MQTT** - Ø¹Ù…ÙŠÙ„ MQTT
- **WebSocket** - Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ
- **Python 3.11+** - Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©

## ğŸ“¦ Ø§Ù„ØªØ«Ø¨ÙŠØª

```bash
cd iot-gateway

# Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
python -m venv venv
source venv/bin/activate  # Linux/Mac
# Ø£Ùˆ
venv\Scripts\activate  # Windows

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
pip install -r requirements.txt
```

## ğŸš€ Ø§Ù„ØªØ´ØºÙŠÙ„

### Development Mode

```bash
# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
uvicorn app.main:app --reload --port 8005

# Ø£Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Python
python -m app.main
```

### Production Mode

```bash
# Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gunicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8005
```

### Docker

```bash
# Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©
docker build -t sahool-iot-gateway .

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
docker run -p 8005:8005 sahool-iot-gateway
```

## ğŸ”§ Ø§Ù„ØªÙƒÙˆÙŠÙ†

### Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©

```env
# MQTT Broker
MQTT_BROKER_HOST=localhost
MQTT_BROKER_PORT=1883
MQTT_USERNAME=sahool
MQTT_PASSWORD=your_password

# Database
DATABASE_URL=postgresql://user:pass@localhost/sahool

# API
API_PORT=8005
LOG_LEVEL=INFO
```

## ğŸ“¡ MQTT Topics

### Topics Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ

```
sahool/sensors/+/data          # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª
sahool/devices/+/status        # Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
sahool/commands/+              # Ø§Ù„Ø£ÙˆØ§Ù…Ø±
```

### Topics Ù„Ù„Ù†Ø´Ø±

```
sahool/commands/{device_id}    # Ø£ÙˆØ§Ù…Ø± Ù„Ù„Ø£Ø¬Ù‡Ø²Ø©
sahool/config/{device_id}      # ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
```

## ğŸ”Œ API Endpoints

### Device Management

```http
GET    /api/v1/devices                 # Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
POST   /api/v1/devices                 # ØªØ³Ø¬ÙŠÙ„ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯
GET    /api/v1/devices/{device_id}     # ØªÙØ§ØµÙŠÙ„ Ø¬Ù‡Ø§Ø²
PUT    /api/v1/devices/{device_id}     # ØªØ­Ø¯ÙŠØ« Ø¬Ù‡Ø§Ø²
DELETE /api/v1/devices/{device_id}     # Ø­Ø°Ù Ø¬Ù‡Ø§Ø²
```

### Sensor Data

```http
GET    /api/v1/sensors/data            # Ø¢Ø®Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª
GET    /api/v1/sensors/data/history    # Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
GET    /api/v1/sensors/{device_id}/latest  # Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù„Ø¬Ù‡Ø§Ø²
```

### Field Devices

```http
GET    /api/v1/fields/{field_id}/devices  # Ø£Ø¬Ù‡Ø²Ø© Ø­Ù‚Ù„ Ù…Ø¹ÙŠÙ†
GET    /api/v1/fields/{field_id}/sensors  # Ø­Ø³Ø§Ø³Ø§Øª Ø­Ù‚Ù„ Ù…Ø¹ÙŠÙ†
```

### WebSocket

```
ws://localhost:8005/ws/sensors         # Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±ÙŠØ©
```

## ğŸ“Š ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

### Sensor Data Message

```json
{
  "device_id": "sensor_001",
  "device_type": "soil_moisture",
  "field_id": 123,
  "timestamp": "2024-11-30T10:30:00Z",
  "data": {
    "moisture": 45.5,
    "temperature": 22.3,
    "battery": 85,
    "signal": -65
  },
  "location": {
    "lat": 24.7136,
    "lon": 46.6753
  }
}
```

### Device Status Message

```json
{
  "device_id": "sensor_001",
  "status": "online",
  "battery_level": 85,
  "signal_strength": -65,
  "firmware_version": "1.2.3",
  "timestamp": "2024-11-30T10:30:00Z"
}
```

## ğŸ” Ø§Ù„Ø£Ù…Ø§Ù†

### Authentication
- JWT tokens Ù„Ù„Ù€ API endpoints
- MQTT username/password
- TLS/SSL Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø¢Ù…Ù†Ø©

### Authorization
- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
- ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù€ Tenant
- Audit logging Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª

## ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±

```bash
# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
pytest

# Ù…Ø¹ Coverage
pytest --cov=app --cov-report=html

# Ø§Ø®ØªØ¨Ø§Ø± MQTT
python tests/test_mqtt_client.py
```

## ğŸ“ Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### ØªØ³Ø¬ÙŠÙ„ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯

```bash
curl -X POST http://localhost:8005/api/v1/devices \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "sensor_001",
    "device_type": "soil_moisture",
    "field_id": 123,
    "location": {
      "lat": 24.7136,
      "lon": 46.6753
    }
  }'
```

### Ù†Ø´Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø³ (MQTT)

```python
import paho.mqtt.client as mqtt
import json

client = mqtt.Client()
client.connect("localhost", 1883, 60)

data = {
    "moisture": 45.5,
    "temperature": 22.3,
    "battery": 85
}

client.publish("sahool/sensors/sensor_001/data", json.dumps(data))
```

### Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ WebSocket

```javascript
const ws = new WebSocket('ws://localhost:8005/ws/sensors');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Sensor data:', data);
};
```

## ğŸ”„ Integration

### Ù…Ø¹ Platform Core
```python
# Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Platform Core
async def send_to_platform(sensor_data):
    async with httpx.AsyncClient() as client:
        await client.post(
            "http://platform-core:8001/api/v1/sensors/data",
            json=sensor_data
        )
```

### Ù…Ø¹ Analytics Core
```python
# Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ­Ù„ÙŠÙ„
async def send_to_analytics(sensor_data):
    async with httpx.AsyncClient() as client:
        await client.post(
            "http://analytics-core:8003/api/v1/analytics/ingest",
            json=sensor_data
        )
```

## ğŸ› Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: "Cannot connect to MQTT broker"
**Ø§Ù„Ø­Ù„:** 
- ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ MQTT broker (Mosquitto)
- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ÙØ° ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†
- ØªØ£ÙƒØ¯ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: "Device not receiving commands"
**Ø§Ù„Ø­Ù„:**
- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙŠ Topic Ø§Ù„ØµØ­ÙŠØ­
- ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
- Ø±Ø§Ø¬Ø¹ logs Ù„Ù„Ø£Ø®Ø·Ø§Ø¡

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: "WebSocket connection drops"
**Ø§Ù„Ø­Ù„:**
- Ø²ÙŠØ§Ø¯Ø© timeout
- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø´Ø¨ÙƒØ©
- Ø§Ø³ØªØ®Ø¯Ø§Ù… reconnection logic

## ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø±Ø¯

- [MQTT Protocol](https://mqtt.org/)
- [Paho MQTT Client](https://www.eclipse.org/paho/)
- [FastAPI WebSocket](https://fastapi.tiangolo.com/advanced/websockets/)

## ğŸš€ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©

- [ ] Ø¯Ø¹Ù… LoRaWAN
- [ ] Ø¯Ø¹Ù… CoAP protocol
- [ ] Device firmware updates OTA
- [ ] Advanced alerting rules
- [ ] ML-based anomaly detection
- [ ] Multi-broker support
- [ ] Device grouping
- [ ] Batch data processing

## ğŸ“ Ø§Ù„Ø¯Ø¹Ù…

Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´Ø§ÙƒÙ„:
- GitHub Issues: https://github.com/kafaat/sahool-project/issues
- Email: support@sahool.com

## ğŸ“„ Ø§Ù„ØªØ±Ø®ÙŠØµ

MIT License - Ø§Ù†Ø¸Ø± Ù…Ù„Ù LICENSE Ù„Ù„ØªÙØ§ØµÙŠÙ„
